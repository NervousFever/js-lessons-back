/**
 * Chỉnh sửa hàm cho oracle __$
 * 
 * Bổ sung từ ver 2.0.6:
 * Hàm chuyển đổi mệnh đề where của mongo ra sql với where + and
 * 
 * Các hàm - operators: $in, $nin, $lt, $gt, $lte, $gte, $ne, $like, $exists, $null
 * @param {*} key_name = tên cột
 * @param {*} operators = các toán tử
 * 
 * OUT chuyển trả ra chuỗi sqlWheres kết quả, nếu có trước thì cộng AND, nếu không có thì trả trống (bỏ WHERE)
 */
module.exports = (key_name, operators, sqlWheres) => {

    let whereS = "";
    for (let oper in operators) {
        let value = operators[oper];
        // $like : "*5" => 
        let trueValue; // giá trị chuyển đổi không phải string '' ở hai đầu
        if (typeof value == "number"){
            trueValue = value;
        } else if (typeof value === "string" && value.indexOf("__$") === 0){
            // chuyển đổi hàm thật
            trueValue = value.substring(3);
        }

        switch (oper) {
            case "$in":
                if (Array.isArray(value)) {
                    whereS += (!whereS ? `` : ` AND `) + `${key_name} in ('${value.join("','")}')`;
                }
                break;
            case "$nin":
                if (Array.isArray(value)) {
                    whereS += (!whereS ? `` : ` AND `) + `${key_name} not in ('${value.join("','")}')`;
                }
                break;
            case "$lt":
                whereS += (!whereS ? `` : ` AND `) + `${key_name} < ${trueValue ? `${trueValue}` : `'${value}'`}`;
                break;
            case "$lte":
                whereS += (!whereS ? `` : ` AND `) + `${key_name} <= ${trueValue ? `${trueValue}` : `'${value}'`}`;
                break;
            case "$gt":
                whereS += (!whereS ? `` : ` AND `) + `${key_name} > ${trueValue ? `${trueValue}` : `'${value}'`}`;
                break;
            case "$gte":
                whereS += (!whereS ? `` : ` AND `) + `${key_name} >= ${trueValue ? `${trueValue}` : `'${value}'`}`;
                break;
            case "$like":
                // thay thế tòa bộ dấu * thành dấu %
                let like = value ? value.replace(/\*/g, '%') : `%`;
                whereS += (!whereS ? `` : ` AND `) + `${key_name} like '${like}'`;
                break;
            case "$null":
                // is null
                let isNull = value ? `is null` : `is not null`;
                whereS += (!whereS ? `` : ` AND `) + `${key_name} ${isNull}`;
                break;
            case "$ne":
                // not equal != or <> or is not null
                let notEqual = value === null ? `is not null` : `!= ${trueValue ? `${trueValue}` : `'${value}'`}`;
                whereS += (!whereS ? `` : ` AND `) + `${key_name} ${notEqual}`;
                break;
            case "$exists":
                let exists = value ? `is not null` : `is null`;
                whereS += (!whereS ? `` : ` AND `) + `${key_name} ${exists}`;
                break;
            default:
                break;
        }
    }
    return sqlWheres ? ` AND ${whereS}` : whereS;
}