/**
 * Bổ sung từ ver 2.0.6:
 * Hàm chuyển đổi mệnh đề where của mongo ra sql với where + and
 * 
 * Các hàm - operators: $in, $nin, $lt, $gt, $lte, $gte, $ne, $like, $exists, $null
 * @param {*} key_name = tên cột
 * @param {*} operators = các toán tử
 * @param {*} iIn = số thứ tự để xác định where hay and
 * 
 * AND:
 */
module.exports = (key_name, operators, iIn) => {
    let iOut = iIn || 0;
    // console.log("***", operators);
    let whereS = "";
    for (let oper in operators) {
        let value = operators[oper];
        // $like : "*5" => 
        switch (oper) {
            case "$in":
                if (Array.isArray(value)) {
                    whereS += (iOut++ === 0 ? ` WHERE ` : ` AND `) + `${key_name} in ('${value.join("','")}')`;
                }
                break;
            case "$nin":
                if (Array.isArray(value)) {
                    whereS += (iOut++ === 0 ? ` WHERE ` : ` AND `) + `${key_name} not in ('${value.join("','")}')`;
                }
                break;
            case "$lt":
                whereS += (iOut++ === 0 ? ` WHERE ` : ` AND `) + `${key_name} < ${typeof value=="number"?`${value}`:`'${value}'`}`;
                break;
            case "$lte":
                whereS += (iOut++ === 0 ? ` WHERE ` : ` AND `) + `${key_name} <= ${typeof value=="number"?`${value}`:`'${value}'`}`;
                break;
            case "$gt":
                whereS += (iOut++ === 0 ? ` WHERE ` : ` AND `) + `${key_name} > ${typeof value=="number"?`${value}`:`'${value}'`}`;
                break;
            case "$gte":
                whereS += (iOut++ === 0 ? ` WHERE ` : ` AND `) + `${key_name} >= ${typeof value=="number"?`${value}`:`'${value}'`}`;
                break;
            case "$like":
                // thay thế tòa bộ dấu * thành dấu %
                let like = value ? value.replace(/\*/g, '%')  : `%`;
                whereS += (iOut++ === 0 ? ` WHERE ` : ` AND `) + `${key_name} like '${like}'`;
                break;
            case "$null":
                // is null
                let isNull = value ? `is null` : `is not null`;
                whereS += (iOut++ === 0 ? ` WHERE ` : ` AND `) + `${key_name} ${isNull}`;
                break;
            case "$ne":
                // not equal != or <> or is not null
                let notEqual = value===null ? `is not null` : `!= ${typeof value=="number"?`${value}`:`'${value}'`}`;
                whereS += (iOut++ === 0 ? ` WHERE ` : ` AND `) + `${key_name} ${notEqual}`;
                break;
            case "$exists":
                let exists = value ? `is not null` : `is null`;
                whereS += (iOut++ === 0 ? ` WHERE ` : ` AND `) + `${key_name} ${exists}`;
                break;
            default:
                break;
        }
    }
    return {
        whereS,
        iOut
    };
}