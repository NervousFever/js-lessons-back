/**
 * Hàm này sẽ trả kết quả json cuối cùng cho người dùng, nếu các hàm trước đó không trả kết quả được
 * Nó sẽ tự động thêm vào route, và trả kết quả theo các điều kiện của req.finalJson, luôn trả về là json kiểu 200 thành công
 * Nếu finalJson không có dữ liệu (nó là object) thì sẽ mặt định trả về đối tượng rỗng {}
 * Đặc biệt nó sẽ tự chuyển đổi các giá trị null = undefined để không trả kết quả null về
 *
 * nếu nó là string thì trả về đối tượng status:"OK", message:"" chính nội dung của string đó
 *
 */
module.exports = (req, res) => {
  let finalJson = req.finalJson || {};
  if (typeof finalJson === "string" || typeof finalJson === "number") {
    finalJson = {
      status: "OK",
      message: finalJson,
    };
  }

  // ghi log truy cập
  if (typeof req.logAccess === "function") {
    try {
      // lưu log truy cập thành công
      req.logAccess("ACCESS", req);
    } catch {}
  }

  res.writeHead(200, { "Content-Type": "application/json; charset=utf-8" });
  res.end(
    JSON.stringify(
      finalJson,
      (key, value) => {
        if (value === null) {
          return undefined;
        }
        return value;
      },
      2
    )
  );
};
